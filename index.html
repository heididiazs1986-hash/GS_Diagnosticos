<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GS Diagn√≥sticos</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d40000" />
  <link rel="icon" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-180.png" />

  <style>
    :root{
      --rojo:#d40000;
      --rojo2:#b50000;
      --gris:#f5f5f5;
      --borde:#d9d9d9;
      --txt:#222;
      --card:#fff;
      --ok:#0a8a0a;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:var(--gris);color:var(--txt)}
    header{
      position:sticky;top:0;z-index:10;
      background:var(--rojo);color:#fff;
      padding:12px 14px;
      display:flex;gap:12px;align-items:center;
    }
    header img{width:44px;height:44px;border-radius:10px;background:#fff;object-fit:contain;padding:4px}
    header .ttl{display:flex;flex-direction:column;line-height:1.1}
    header .ttl b{font-size:18px}
    header .ttl small{opacity:.95}
    header .badge{
      margin-left:auto;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.22);
      padding:8px 12px;border-radius:999px;
      font-weight:700;
    }

    main{padding:14px;max-width:980px;margin:0 auto}

    .card{
      background:var(--card);
      border:1px solid var(--borde);
      border-radius:18px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
    }

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}

    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--borde);
      border-radius:14px;
      background:#fff;
      font-size:16px;
      outline:none;
    }
    input[readonly]{background:#fafafa}
    textarea{min-height:110px;resize:vertical}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button, a.btn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .primary{background:var(--rojo);color:#fff}
    .primary:active{background:var(--rojo2)}
    .secondary{background:#fff;color:#222;border:1px solid var(--borde)}
    .ghost{background:#fff;color:var(--rojo);border:1px solid rgba(212,0,0,.35)}
    .ok{background:var(--ok);color:#fff}
    .warn{background:#fff;color:#a40000;border:1px solid rgba(164,0,0,.35)}

    .navBtns{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-start;
      margin:10px 0 4px;
    }
    .navBtns button{min-width:140px}
    .pill{
      margin-left:auto;
      background:#fff;border:1px solid rgba(255,255,255,.4);
      color:#fff;
      padding:10px 12px;border-radius:999px;
      display:flex;align-items:center;gap:8px;
      font-weight:900;
    }
    .pill span{display:inline-block;background:rgba(255,255,255,.16);padding:6px 10px;border-radius:999px}
    .sectionTitle{font-size:22px;font-weight:900;margin:2px 0 8px}
    .hr{height:1px;background:var(--borde);margin:12px 0}

    .chk{
      display:flex;align-items:center;gap:10px;
      font-size:18px;
      padding:10px 0;
      user-select:none;
    }
    .chk input[type="checkbox"]{width:24px;height:24px}

    .smallNote{font-size:12px;opacity:.75}

    .micBtn{
      width:56px;height:56px;border-radius:16px;
      border:1px solid var(--borde);
      background:#fff;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
    }

    .coordsRow{display:flex;gap:10px;flex-wrap:wrap}
    .coordsRow .col{min-width:160px}
    .coordsActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}

    .hidden{display:none !important}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:999px;
      font-weight:800;z-index:9999;opacity:0;pointer-events:none;
      transition:opacity .2s ease;
    }
    .toast.show{opacity:.95}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;
      z-index:9998;
      padding:16px;
    }
    .modal .box{
      width:min(560px, 100%);
      background:#fff;border-radius:20px;
      border:1px solid var(--borde);
      padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.2);
    }
    .modal h3{margin:0 0 10px;font-size:20px}
    .modal .list button{width:100%;margin-top:10px}
  </style>
</head>

<body>
<header>
  <img src="/LOGO.jpg" alt="Logo" onerror="this.style.display='none'">
  <div class="ttl">
    <b>GS Diagn√≥sticos</b>
    <small>GSocial DX</small>
  </div>
  <div class="badge" id="badge">Listo ‚úÖ</div>
</header>

<main>
  <div class="card">
    <div class="row" style="align-items:center;">
      <div class="col">
        <div class="sectionTitle">Caracterizaci√≥n</div>
      </div>
      <div class="col" style="text-align:right;">
        <span class="pill">‚ö° <span id="cdPill">CD: (SIN)</span></span>
      </div>
    </div>

    <div class="navBtns">
      <button class="primary" id="btnUNC" type="button">UNC</button>
      <button class="primary" id="btnCliente" type="button">Cliente</button>
      <button class="primary" id="btnSusp" type="button">Suspensi√≥n</button>
      <button class="primary" id="btnBaldio" type="button">Bald√≠os</button>
      <button class="secondary" id="btnVolverEstructuras" type="button">Volver</button>
    </div>

    <div class="hr"></div>

    <!-- ESTRUCTURAS -->
    <div id="formEstructuras">
      <div class="sectionTitle">ESTRUCTURAS</div>

      <label>Modo</label>
      <div class="row">
        <label class="chk" style="flex:1;margin:0;">
          <input type="radio" name="modoCD" id="modoNuevo" checked>
          Crear nuevo CD
        </label>
        <label class="chk" style="flex:1;margin:0;">
          <input type="radio" name="modoCD" id="modoContinuar">
          Continuar con CD activo
        </label>
      </div>

      <div class="row">
        <div class="col">
          <label>Transformador (CD)</label>
          <input id="cdInput" placeholder="E12123TR1" inputmode="text" autocomplete="off">
          <div class="smallNote">Alfanum√©rico en MAY√öSCULA (sin espacios). Ej: E12123TR1</div>
        </div>
        <div class="col">
          <label>Capacidad transformador kVA (no se exporta en Excel)</label>
          <select id="capSelect">
            <option value="">Selecciona...</option>
            <option>5</option><option>10</option><option>15</option><option>25</option><option>37.5</option>
            <option>50</option><option>75</option><option>100</option><option>112.5</option><option>150</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Tipo de nodo</label>
          <select id="tipoNodo">
            <option value="">Selecciona...</option>
            <option value="NODO MT">Nodo MT</option>
            <option value="NODO BT">Nodo BT</option>
            <option value="NODO CLIENTE">Nodo Cliente</option>
          </select>
        </div>
        <div class="col">
          <label>Material nodo</label>
          <select id="materialNodo">
            <option value="">Selecciona...</option>
            <option value="HORMIG√ìN">Hormig√≥n</option>
            <option value="MADERA">Madera</option>
            <option value="MET√ÅLICO">Met√°lico</option>
            <option value="OTRO">Otro</option>
          </select>
        </div>
      </div>

      <label>Caracter√≠sticas nodo</label>
      <select id="carNodo">
        <option value="">Selecciona...</option>
      </select>

      <label>Punto F√≠sico</label>
      <input id="est_puntofisico" placeholder="Ej: 1472580" inputmode="text" autocomplete="off">

      <div class="coordsRow">
        <div class="col">
          <label>Latitud (Y)</label>
          <input id="est_lat" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Longitud (X)</label>
          <input id="est_lon" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Precisi√≥n (m)</label>
          <input id="est_acc" readonly placeholder="GPS">
        </div>
      </div>
      <div class="coordsActions">
        <button class="secondary" id="btnGPS_Est" type="button">üìç Coordenadas</button>
        <span class="smallNote" id="gpsInfoEst"></span>
      </div>

      <label>Fotos (m√°x. 7)</label>
      <input id="est_fotos" type="file" accept="image/*" multiple>

      <label>Observaciones (dictado + MAY√öSCULA)</label>
      <div class="row">
        <div class="col">
          <textarea id="est_obs" placeholder="(OBLIGATORIO)"></textarea>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="micBtn" id="mic_est" type="button" title="Dictado">üé§</button>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGuardarEst" type="button">Guardar</button>
        <button class="secondary" id="btnLimpiarEst" type="button">Limpiar</button>
      </div>

      <div class="hr"></div>

      <button class="primary" id="btnRegistrarDiag" type="button">Registrar diagn√≥stico</button>

      <div class="hr"></div>

      <button class="secondary" id="btnExportar" type="button">Exportar (Excel + Fotos ZIP)</button>

      <div class="btnrow">
        <button class="secondary" id="btnActualizar" type="button">Actualizar</button>
        <button class="secondary" id="btnConteos" type="button">Conteos</button>
      </div>

      <div class="smallNote" id="conteosTxt" style="margin-top:10px;"></div>
    </div>

    <!-- UNC -->
    <div id="formUNC" class="hidden">
      <div class="sectionTitle">UNC</div>

      <label>Nombres</label>
      <input id="unc_nombres" placeholder="NOMBRES Y APELLIDOS" autocomplete="off">

      <label>Documento</label>
      <input id="unc_doc" placeholder="CC / CE / NIT" inputmode="text" autocomplete="off">

      <label>Sede</label>
      <select id="unc_sede">
        <option value="">Selecciona...</option>
        <option value="FACATATIV√Å">FACATATIV√Å</option>
        <option value="ZIPAQUIR√Å">ZIPAQUIR√Å</option>
        <option value="CH√çA">CH√çA</option>
        <option value="SOACHA">SOACHA</option>
        <option value="FUSAGASUG√Å">FUSAGASUG√Å</option>
        <option value="OTRA">OTRA</option>
      </select>

      <label>Municipio</label>
      <select id="unc_mpio">
        <option value="">Selecciona...</option>
      </select>

      <label>Localidad</label>
      <input id="unc_localidad" placeholder="LOCALIDAD" autocomplete="off">

      <label>¬øRequiere muro?</label>
      <label class="chk"><input type="checkbox" id="unc_muro"> Requiere muro</label>

      <label class="chk"><input type="checkbox" id="unc_arriostre"> ¬øRequiere uso de arriostre?</label>

      <div class="coordsRow">
        <div class="col">
          <label>Latitud (Y)</label>
          <input id="unc_lat" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Longitud (X)</label>
          <input id="unc_lon" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Precisi√≥n (m)</label>
          <input id="unc_acc" readonly placeholder="GPS">
        </div>
      </div>
      <div class="coordsActions">
        <button class="secondary" id="btnGPS_UNC" type="button">üìç Coordenadas</button>
        <span class="smallNote" id="gpsInfoUNC"></span>
      </div>

      <label>Fotos (m√°x. 7)</label>
      <input id="unc_fotos" type="file" accept="image/*" multiple>

      <label>Observaciones (dictado + MAY√öSCULA)</label>
      <div class="row">
        <div class="col">
          <textarea id="unc_obs" placeholder="(OBLIGATORIO)"></textarea>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="micBtn" id="mic_unc" type="button">üé§</button>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGuardarUNC" type="button">Guardar</button>
        <button class="secondary" id="btnCancelarUNC" type="button">Cancelar</button>
      </div>
    </div>

    <!-- CLIENTES -->
    <div id="formCliente" class="hidden">
      <div class="sectionTitle">CLIENTES</div>

      <label>Punto F√≠sico</label>
      <input id="cli_pf" placeholder="PUNTO F√çSICO" autocomplete="off">

      <label>Serie de medidor</label>
      <input id="cli_medidor" placeholder="SERIE" inputmode="text" autocomplete="off">

      <label>Marca de medidor</label>
      <input id="cli_marca" placeholder="MARCA" autocomplete="off">

      <label>No. Fases</label>
      <select id="cli_fases">
        <option value="">Selecciona...</option>
        <option>1</option><option>2</option><option>3</option>
      </select>

      <div class="coordsRow">
        <div class="col">
          <label>Latitud (Y)</label>
          <input id="cli_lat" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Longitud (X)</label>
          <input id="cli_lon" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Precisi√≥n (m)</label>
          <input id="cli_acc" readonly placeholder="GPS">
        </div>
      </div>
      <div class="coordsActions">
        <button class="secondary" id="btnGPS_CLI" type="button">üìç Coordenadas</button>
        <span class="smallNote" id="gpsInfoCLI"></span>
      </div>

      <label>Fotos (m√°x. 7)</label>
      <input id="cli_fotos" type="file" accept="image/*" multiple>

      <label>Observaciones (dictado + MAY√öSCULA)</label>
      <div class="row">
        <div class="col">
          <textarea id="cli_obs" placeholder="(OBLIGATORIO)"></textarea>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="micBtn" id="mic_cli" type="button">üé§</button>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGuardarCLI" type="button">Guardar</button>
        <button class="secondary" id="btnCancelarCLI" type="button">Cancelar</button>
      </div>
    </div>

    <!-- SUSPENSIONES -->
    <div id="formSusp" class="hidden">
      <div class="sectionTitle">SUSPENSI√ìN</div>

      <label>Punto F√≠sico</label>
      <input id="sus_pf" placeholder="PUNTO F√çSICO" autocomplete="off">

      <label>Motivo</label>
      <select id="sus_motivo">
        <option value="">Selecciona...</option>
        <option value="SUSPENSI√ìN POR FRAUDE">Suspensi√≥n por fraude</option>
        <option value="SUSPENSI√ìN POR RIESGO">Suspensi√≥n por riesgo</option>
        <option value="SUSPENSI√ìN POR MOROSIDAD">Suspensi√≥n por morosidad</option>
        <option value="OTRO">Otro</option>
      </select>

      <div class="coordsRow">
        <div class="col">
          <label>Latitud (Y)</label>
          <input id="sus_lat" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Longitud (X)</label>
          <input id="sus_lon" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Precisi√≥n (m)</label>
          <input id="sus_acc" readonly placeholder="GPS">
        </div>
      </div>
      <div class="coordsActions">
        <button class="secondary" id="btnGPS_SUS" type="button">üìç Coordenadas</button>
        <span class="smallNote" id="gpsInfoSUS"></span>
      </div>

      <label>Fotos (m√°x. 7)</label>
      <input id="sus_fotos" type="file" accept="image/*" multiple>

      <label>Observaciones (dictado + MAY√öSCULA)</label>
      <div class="row">
        <div class="col">
          <textarea id="sus_obs" placeholder="(OBLIGATORIO)"></textarea>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="micBtn" id="mic_sus" type="button">üé§</button>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGuardarSUS" type="button">Guardar</button>
        <button class="secondary" id="btnCancelarSUS" type="button">Cancelar</button>
      </div>
    </div>

    <!-- BALDIOS -->
    <div id="formBaldio" class="hidden">
      <div class="sectionTitle">BALD√çOS</div>

      <label>Punto F√≠sico</label>
      <input id="bal_pf" placeholder="PUNTO F√çSICO" autocomplete="off">

      <label>Estado</label>
      <select id="bal_estado">
        <option value="">Selecciona...</option>
        <option value="OCUPADO">Ocupado</option>
        <option value="DESOCUPADO">Desocupado</option>
        <option value="EN CONSTRUCCI√ìN">En construcci√≥n</option>
        <option value="OTRO">Otro</option>
      </select>

      <div class="coordsRow">
        <div class="col">
          <label>Latitud (Y)</label>
          <input id="bal_lat" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Longitud (X)</label>
          <input id="bal_lon" readonly placeholder="GPS">
        </div>
        <div class="col">
          <label>Precisi√≥n (m)</label>
          <input id="bal_acc" readonly placeholder="GPS">
        </div>
      </div>
      <div class="coordsActions">
        <button class="secondary" id="btnGPS_BAL" type="button">üìç Coordenadas</button>
        <span class="smallNote" id="gpsInfoBAL"></span>
      </div>

      <label>Fotos (m√°x. 7)</label>
      <input id="bal_fotos" type="file" accept="image/*" multiple>

      <label>Observaciones (dictado + MAY√öSCULA)</label>
      <div class="row">
        <div class="col">
          <textarea id="bal_obs" placeholder="(OBLIGATORIO)"></textarea>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="micBtn" id="mic_bal" type="button">üé§</button>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGuardarBAL" type="button">Guardar</button>
        <button class="secondary" id="btnCancelarBAL" type="button">Cancelar</button>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Modal: otro registro -->
<div class="modal" id="modalOtro">
  <div class="box">
    <h3>¬øDESEA REALIZAR OTRO REGISTRO EN ESTE NODO?</h3>
    <div class="list">
      <button class="secondary" id="mUNC" type="button">UNC</button>
      <button class="secondary" id="mCLI" type="button">CLIENTE</button>
      <button class="secondary" id="mSUS" type="button">SUSPENSI√ìN</button>
      <button class="secondary" id="mBAL" type="button">BALD√çO</button>
      <button class="primary" id="mNO" type="button">NO</button>
    </div>
  </div>
</div>

<!-- Modal: descarga -->
<div class="modal" id="modalDL">
  <div class="box">
    <h3>Descarga lista</h3>
    <p>Si tu celular bloque√≥ la descarga autom√°tica, toca aqu√≠:</p>
    <div class="btnrow">
      <a class="btn ok" id="dlLink" href="#" download>Descargar ZIP</a>
      <button class="secondary" id="dlClose" type="button">Cerrar</button>
    </div>
    <p class="smallNote">Si est√°s en iPhone, usa el bot√≥n ‚ÄúCompartir‚Äù del navegador si no descarga directo.</p>
  </div>
</div>

<script>
/* ==========================
   UTILIDADES / UI
========================== */
const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 2200);
}
function setBadge(t){ $("badge").textContent = t; }
function upperAlnum(s){ return (s||"").toString().toUpperCase().replace(/[^A-Z0-9]/g,""); }
function upperText(s){ return (s||"").toString().toUpperCase(); }
function safeName(s){
  return (s||"").toString().trim().replace(/\s+/g,"_").replace(/[^A-Z0-9_\-]/gi,"_");
}
function showOnly(formId){
  ["formEstructuras","formUNC","formCliente","formSusp","formBaldio"].forEach(id=>{
    $(id).classList.toggle("hidden", id!==formId);
  });
}

/* ==========================
   MUNICIPIOS (incluye Facatativ√° y Zipaquir√°)
   Puedes ampliar esta lista cuando quieras.
========================== */
const MUNICIPIOS = [
 "AGUA DE DIOS","ALB√ÅN","ANAPOIMA","ANOLAIMA","APULO","ARBEL√ÅEZ","BELTR√ÅN","BITUIMA","BOJAC√Å",
 "CABRERA","CACHIPAY","CAJIC√Å","CAPARRAP√ç","C√ÅQUEZA","CARMEN DE CARUPA","CHAGUAN√ç","CH√çA","CHIPAQUE",
 "CHOACH√ç","CHOCONT√Å","COGUA","COTA","CUCUNUB√Å","EL COLEGIO","EL PE√ë√ìN","EL ROSAL","FACATATIV√Å",
 "F√ìMEQUE","FOSCA","FUNZA","F√öQUENE","FUSAGASUG√Å","GACHAL√Å","GACHANCIP√Å","GACHET√Å","GAMA","GIRARDOT",
 "GRANADA","GUACHET√Å","GUADUAS","GUASCA","GUATAQU√ç","GUATAVITA","GUAYABAL DE S√çQUIMA","GUAYABETAL",
 "GUTI√âRREZ","JERUSAL√âN","JUN√çN","LA CALERA","LA MESA","LA PALMA","LA PE√ëA","LA VEGA","LENGUAZAQUE",
 "MACHET√Å","MADRID","MANTA","MEDINA","MOSQUERA","NARI√ëO","NEMOC√ìN","NILO","NIMAIMA","NOCAIMA","PACHO",
 "PAIME","PANDI","PARATEBUENO","PASCA","PUERTO SALGAR","PUL√ç","QUEBRADANEGRA","QUETAME","QU√çPILE",
 "RAFAEL REYES","RICAURTE","SAN ANTONIO DEL TEQUENDAMA","SAN BERNARDO","SAN CAYETANO","SAN FRANCISCO",
 "SAN JUAN DE RIOSECO","SASAIMA","SESQUIL√â","SIBAT√â","SILVANIA","SIMIJACA","SOACHA","SOP√ì","SUBACHOQUE",
 "SUESCA","SUPAT√Å","SUSA","SUTATAUSA","TABIO","TAUSA","TENA","TENJO","TIBACUY","TIBIRITA","TOCAIMA",
 "TOCANCIP√Å","TOPAIP√ç","UBAL√Å","UBAQUE","UBAT√â","UNE","√öTICA","VENECIA","VERGARA","VIAN√ç","VILLAG√ìMEZ",
 "VILLAPINZ√ìN","VILLETA","VIOT√Å","YACOP√ç","ZIPAC√ìN","ZIPAQUIR√Å"
];
function fillMunicipios(){
  const sel = $("unc_mpio");
  sel.innerHTML = `<option value="">Selecciona...</option>` + MUNICIPIOS.map(m=>`<option value="${m}">${m}</option>`).join("");
}

/* ==========================
   CARACTER√çSTICAS NODO
========================== */
const CAR_MAP = {
  "NODO MT": {
    "HORMIG√ìN": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "MADERA": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "MET√ÅLICO": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "OTRO": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN"]
  },
  "NODO BT": {
    "HORMIG√ìN": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "MADERA": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "MET√ÅLICO": ["APOYO","RETENIDA","FIN DE L√çNEA","DERIVACI√ìN","CRUCE","ANGULAR"],
    "OTRO": ["APOYO","DERIVACI√ìN","FIN DE L√çNEA"]
  },
  "NODO CLIENTE": {
    "HORMIG√ìN": ["ACOMETIDA","MEDIDA","APOYO","OTRO"],
    "MADERA": ["ACOMETIDA","MEDIDA","APOYO","OTRO"],
    "MET√ÅLICO": ["ACOMETIDA","MEDIDA","APOYO","OTRO"],
    "OTRO": ["ACOMETIDA","MEDIDA","OTRO"]
  }
};

function fillCarNodo(){
  const tipo = $("tipoNodo").value;
  const mat = $("materialNodo").value;
  const sel = $("carNodo");
  const prev = sel.value;
  const opts = (CAR_MAP[tipo] && CAR_MAP[tipo][mat]) ? CAR_MAP[tipo][mat] : [];
  sel.innerHTML = `<option value="">Selecciona...</option>` + opts.map(o=>`<option value="${o}">${o}</option>`).join("");
  if(opts.includes(prev)) sel.value = prev;
}

/* ==========================
   GPS
========================== */
function captureGPS(latEl, lonEl, accEl, infoEl){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){
      toast("GPS no disponible");
      return resolve(null);
    }
    setBadge("Capturando GPS‚Ä¶ üì°");
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        latEl.value = lat.toFixed(6);
        lonEl.value = lon.toFixed(6);
        accEl.value = Math.round(acc);
        const t = new Date().toISOString();
        latEl.dataset.gpsISO = t;
        accEl.dataset.gpsISO = t;
        if(infoEl) infoEl.textContent = `GPS OK ‚Ä¢ ${new Date().toLocaleString()}`;
        setBadge("Listo ‚úÖ");
        resolve({lat,lon,acc, t});
      },
      (err)=>{
        console.error(err);
        setBadge("Listo ‚úÖ");
        toast("No se pudo capturar GPS");
        resolve(null);
      },
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  });
}

/* ==========================
   DICTADO (Web Speech API)
========================== */
function startDictation(textarea){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    toast("Dictado no disponible");
    return;
  }
  const rec = new SR();
  rec.lang = "es-CO";
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  setBadge("Escuchando‚Ä¶ üé§");
  rec.onresult = (e)=>{
    const t = e.results[0][0].transcript || "";
    textarea.value = upperText((textarea.value||"") + " " + t).trim();
    setBadge("Listo ‚úÖ");
  };
  rec.onerror = ()=>{ setBadge("Listo ‚úÖ"); toast("Dictado fall√≥"); };
  rec.onend = ()=>{ setBadge("Listo ‚úÖ"); };
  rec.start();
}

/* ==========================
   FOTOS (m√°x 7) -> dataURL
========================== */
async function filesToDataURLs(fileInput){
  const files = Array.from(fileInput.files || []);
  if(files.length > 7){
    toast("M√°ximo 7 fotos");
    fileInput.value = "";
    return [];
  }
  const out = [];
  for(const f of files){
    const dataURL = await new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });
    out.push({name:f.name, dataURL});
  }
  return out;
}

/* ==========================
   INDEXEDDB
========================== */
const DB_NAME = "gsdx_db";
const DB_VER = 1;
let db = null;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d = req.result;
      const mk = (name)=>{
        if(!d.objectStoreNames.contains(name)){
          d.createObjectStore(name, { keyPath:"id", autoIncrement:true });
        }
      };
      mk("estructuras");
      mk("unc");
      mk("clientes");
      mk("susp");
      mk("baldios");
      if(!d.objectStoreNames.contains("meta")){
        d.createObjectStore("meta", { keyPath:"k" });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(db); };
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  return db.transaction(store, mode).objectStore(store);
}

function metaGet(k){
  return new Promise((resolve)=>{
    const r = tx("meta").get(k);
    r.onsuccess = ()=>resolve(r.result ? r.result.v : null);
    r.onerror = ()=>resolve(null);
  });
}
function metaSet(k,v){
  return new Promise((resolve)=>{
    const r = tx("meta","readwrite").put({k, v});
    r.onsuccess = ()=>resolve(true);
    r.onerror = ()=>resolve(false);
  });
}

function addRec(store, obj){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readwrite").add(obj);
    r.onsuccess = ()=>resolve(r.result);
    r.onerror = ()=>reject(r.error);
  });
}
function getAll(store){
  return new Promise((resolve)=>{
    const r = tx(store).getAll();
    r.onsuccess = ()=>resolve(r.result || []);
    r.onerror = ()=>resolve([]);
  });
}

/* ==========================
   ESTADO GLOBAL
========================== */
let activeCD = "";
function setActiveCD(cd){
  activeCD = cd;
  $("cdPill").textContent = "CD: " + (cd || "(SIN)");
}
function nowISO(){ return new Date().toISOString(); }
function nowHuman(){ return new Date().toLocaleString(); }

/* ==========================
   VALIDACIONES
========================== */
function requireVal(v, msg){
  if(!v || !v.toString().trim()){ toast(msg); return false; }
  return true;
}
function requireGPS(latEl, lonEl, accEl){
  if(!latEl.value || !lonEl.value || !accEl.value){
    toast("Falta capturar coordenadas");
    return false;
  }
  return true;
}

/* ==========================
   EXCEL (HTML .XLS)
   - SIN columna Capacidad
   - CON Punto F√≠sico
   - CON Precisi√≥n
   - CON FECHA_HORA y GPS_HORA
========================== */
function esc(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function sheetTable(name, headers, rows){
  let html = `<table border="1"><tr><th colspan="${headers.length}" style="font-weight:900">${esc(name)}</th></tr>`;
  html += `<tr>${headers.map(h=>`<th>${esc(h)}</th>`).join("")}</tr>`;
  for(const r of rows){
    html += `<tr>${r.map(c=>`<td>${esc(c)}</td>`).join("")}</tr>`;
  }
  html += `</table><br/>`;
  return html;
}

function buildExcel(estr, unc, cli, sus, bal){
  const hEstr = ["CD","PUNTO_FISICO","TIPO_NODO","MATERIAL_NODO","CARACTERISTICAS","LAT","LON","PRECISION_M","OBSERVACIONES","FECHA_HORA","GPS_HORA"];
  const rEstr = estr.map(r=>[
    r.CD, r.PuntoFisico, r.TipoNodo, r.MaterialNodo, r.CaracteristicasNodo,
    r.Latitud, r.Longitud, r.Precision, r.Observaciones, r.FECHA_HORA, r.GPS_HORA
  ]);

  const hUNC = ["CD","NOMBRES","DOCUMENTO","SEDE","MUNICIPIO","LOCALIDAD","REQ_MURO","REQ_ARRIOSTRE","LAT","LON","PRECISION_M","OBSERVACIONES","FECHA_HORA","GPS_HORA"];
  const rUNC = unc.map(r=>[
    r.CD, r.Nombres, r.Documento, r.Sede, r.Municipio, r.Localidad,
    r.RequiereMuro, r.RequiereArriostre,
    r.Latitud, r.Longitud, r.Precision, r.Observaciones, r.FECHA_HORA, r.GPS_HORA
  ]);

  const hCLI = ["CD","PUNTO_FISICO","SERIE_MEDIDOR","MARCA","FASES","LAT","LON","PRECISION_M","OBSERVACIONES","FECHA_HORA","GPS_HORA"];
  const rCLI = cli.map(r=>[
    r.CD, r.PuntoFisico, r.SerieMedidor, r.Marca, r.Fases,
    r.Latitud, r.Longitud, r.Precision, r.Observaciones, r.FECHA_HORA, r.GPS_HORA
  ]);

  const hSUS = ["CD","PUNTO_FISICO","MOTIVO","LAT","LON","PRECISION_M","OBSERVACIONES","FECHA_HORA","GPS_HORA"];
  const rSUS = sus.map(r=>[
    r.CD, r.PuntoFisico, r.Motivo,
    r.Latitud, r.Longitud, r.Precision, r.Observaciones, r.FECHA_HORA, r.GPS_HORA
  ]);

  const hBAL = ["CD","PUNTO_FISICO","ESTADO","LAT","LON","PRECISION_M","OBSERVACIONES","FECHA_HORA","GPS_HORA"];
  const rBAL = bal.map(r=>[
    r.CD, r.PuntoFisico, r.Estado,
    r.Latitud, r.Longitud, r.Precision, r.Observaciones, r.FECHA_HORA, r.GPS_HORA
  ]);

  const html =
`<html><head><meta charset="UTF-8"></head><body>
${sheetTable("ESTRUCTURAS", hEstr, rEstr)}
${sheetTable("UNC", hUNC, rUNC)}
${sheetTable("CLIENTES", hCLI, rCLI)}
${sheetTable("SUSPENSIONES", hSUS, rSUS)}
${sheetTable("BALDIOS", hBAL, rBAL)}
</body></html>`;

  // Excel acepta HTML con MIME xls
  return new TextEncoder().encode(html);
}

/* ==========================
   ZIP muy liviano (STORE, sin compresi√≥n)
   Suficiente para fotos + excel.
========================== */
class TinyZip {
  constructor(){ this.files = []; }
  add(path, u8){
    const name = path.replace(/^\/+/,"");
    this.files.push({name, u8});
  }
  finalize(){
    const fileRecs = [];
    const cenRecs = [];
    let offset = 0;

    const enc = new TextEncoder();
    const dt = new Date();
    const dosTime = ((dt.getHours() & 0x1f) << 11) | ((dt.getMinutes() & 0x3f) << 5) | ((Math.floor(dt.getSeconds()/2)) & 0x1f);
    const dosDate = (((dt.getFullYear()-1980) & 0x7f) << 9) | (((dt.getMonth()+1) & 0xf) << 5) | (dt.getDate() & 0x1f);

    const crc32 = (u8)=>{
      let c = ~0;
      for(let i=0;i<u8.length;i++){
        c ^= u8[i];
        for(let k=0;k<8;k++){
          c = (c >>> 1) ^ (0xEDB88320 & (-(c & 1)));
        }
      }
      return (~c) >>> 0;
    };

    for(const f of this.files){
      const nameU8 = enc.encode(f.name);
      const data = f.u8;
      const crc = crc32(data);
      const compSize = data.length;
      const uncompSize = data.length;

      // Local file header
      const lfh = new Uint8Array(30 + nameU8.length);
      const dv = new DataView(lfh.buffer);
      dv.setUint32(0, 0x04034b50, true); // sig
      dv.setUint16(4, 20, true); // ver
      dv.setUint16(6, 0, true); // flag
      dv.setUint16(8, 0, true); // method store
      dv.setUint16(10, dosTime, true);
      dv.setUint16(12, dosDate, true);
      dv.setUint32(14, crc, true);
      dv.setUint32(18, compSize, true);
      dv.setUint32(22, uncompSize, true);
      dv.setUint16(26, nameU8.length, true);
      dv.setUint16(28, 0, true); // extra len
      lfh.set(nameU8, 30);

      fileRecs.push(lfh, data);

      // Central directory header
      const cdh = new Uint8Array(46 + nameU8.length);
      const cv = new DataView(cdh.buffer);
      cv.setUint32(0, 0x02014b50, true);
      cv.setUint16(4, 20, true); // ver made
      cv.setUint16(6, 20, true); // ver needed
      cv.setUint16(8, 0, true);
      cv.setUint16(10, 0, true);
      cv.setUint16(12, dosTime, true);
      cv.setUint16(14, dosDate, true);
      cv.setUint32(16, crc, true);
      cv.setUint32(20, compSize, true);
      cv.setUint32(24, uncompSize, true);
      cv.setUint16(28, nameU8.length, true);
      cv.setUint16(30, 0, true);
      cv.setUint16(32, 0, true);
      cv.setUint16(34, 0, true);
      cv.setUint16(36, 0, true);
      cv.setUint32(38, 0, true);
      cv.setUint32(42, offset, true);
      cdh.set(nameU8, 46);

      cenRecs.push(cdh);

      offset += lfh.length + data.length;
    }

    const cenOffset = offset;
    let cenSize = 0;
    for(const c of cenRecs) cenSize += c.length;

    // End of central directory
    const eocd = new Uint8Array(22);
    const ev = new DataView(eocd.buffer);
    ev.setUint32(0, 0x06054b50, true);
    ev.setUint16(4, 0, true);
    ev.setUint16(6, 0, true);
    ev.setUint16(8, this.files.length, true);
    ev.setUint16(10, this.files.length, true);
    ev.setUint32(12, cenSize, true);
    ev.setUint32(16, cenOffset, true);
    ev.setUint16(20, 0, true);

    const total = cenOffset + cenSize + eocd.length;
    const out = new Uint8Array(total);
    let p = 0;
    for(const r of fileRecs){ out.set(r, p); p += r.length; }
    for(const r of cenRecs){ out.set(r, p); p += r.length; }
    out.set(eocd, p);
    return out;
  }
}

function dataURLtoU8(dataURL){
  const base64 = dataURL.split(",")[1] || "";
  const bin = atob(base64);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
  return u8;
}

function downloadU8(filename, mime, u8){
  const blob = new Blob([u8], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
}

/* ==========================
   GUARDADOS (Estructuras y dem√°s)
========================== */
async function ensureReady(){
  if(!db) await openDB();
  fillMunicipios();
  fillCarNodo();
}

function enforceUpperInputs(){
  // CD: alfanum√©rico + may√∫scula en vivo
  $("cdInput").addEventListener("input", ()=>{
    const v = upperAlnum($("cdInput").value);
    $("cdInput").value = v;
  });

  // campos alfanum√©ricos/tex en may√∫scula (sin forzar eliminar tildes)
  const up = (id)=>$(id).addEventListener("input", ()=>{ $(id).value = upperText($(id).value); });
  up("est_puntofisico");
  up("est_obs");
  up("unc_nombres");
  up("unc_doc");
  up("unc_localidad");
  up("unc_obs");
  up("cli_pf");
  up("cli_medidor");
  up("cli_marca");
  up("cli_obs");
  up("sus_pf");
  up("sus_obs");
  up("bal_pf");
  up("bal_obs");
}

function setSedeMunicipioUpper(){
  $("unc_sede").addEventListener("change", ()=>{
    $("unc_sede").value = upperText($("unc_sede").value);
  });
  $("unc_mpio").addEventListener("change", ()=>{
    $("unc_mpio").value = upperText($("unc_mpio").value);
  });
}

async function guardarEstructura(){
  await ensureReady();

  const modoNuevo = $("modoNuevo").checked;

  // Reglas: export obligatorio antes de crear nuevo CD (si hay pendiente)
  const dirty = await metaGet("dirty");
  if(modoNuevo && dirty){
    toast("Debes exportar antes de crear un CD nuevo");
    return;
  }

  let cd = upperAlnum($("cdInput").value);
  if(!requireVal(cd, "Falta CD")) return;

  // Si est√° en modo continuar, usa el CD activo aunque cambien el input
  if($("modoContinuar").checked){
    if(!activeCD){ toast("No hay CD activo"); return; }
    cd = activeCD;
    $("cdInput").value = cd;
  }

  // Validaciones obligatorias
  if(!requireVal($("tipoNodo").value, "Falta Tipo nodo")) return;
  if(!requireVal($("materialNodo").value, "Falta Material nodo")) return;
  if(!requireVal($("carNodo").value, "Falta Caracter√≠sticas nodo")) return;
  if(!requireVal($("est_puntofisico").value, "Falta Punto F√≠sico")) return;
  if(!requireVal($("est_obs").value, "Falta Observaciones")) return;
  if(!requireGPS($("est_lat"),$("est_lon"),$("est_acc"))) return;

  const fotos = await filesToDataURLs($("est_fotos"));
  const tSave = nowISO();
  const gpsISO = $("est_lat").dataset.gpsISO || "";

  const rec = {
    CD: cd,
    TipoNodo: $("tipoNodo").value,
    MaterialNodo: $("materialNodo").value,
    CaracteristicasNodo: $("carNodo").value,
    PuntoFisico: upperText($("est_puntofisico").value),
    Latitud: $("est_lat").value,
    Longitud: $("est_lon").value,
    Precision: $("est_acc").value,
    Observaciones: upperText($("est_obs").value),
    Fotos: fotos,
    FECHA_HORA: new Date(tSave).toLocaleString(),
    GPS_HORA: gpsISO ? new Date(gpsISO).toLocaleString() : ""
  };

  await addRec("estructuras", rec);

  setActiveCD(cd);
  await metaSet("activeCD", cd);
  await metaSet("dirty", true);

  toast("Guardado ‚úÖ");
  setBadge("Listo ‚úÖ");

  // Limpieza autom√°tica al guardar (excepto CD)
  $("tipoNodo").value = "";
  $("materialNodo").value = "";
  fillCarNodo();
  $("est_puntofisico").value = "";
  $("est_lat").value = "";
  $("est_lon").value = "";
  $("est_acc").value = "";
  $("est_lat").dataset.gpsISO = "";
  $("est_obs").value = "";
  $("est_fotos").value = "";
  $("gpsInfoEst").textContent = "";

  // Modal de ‚Äúotro registro‚Äù
  $("modalOtro").style.display = "flex";
}

async function guardarUNC(){
  await ensureReady();
  if(!activeCD){ toast("No hay CD activo"); return; }

  if(!requireVal($("unc_nombres").value, "Falta Nombres")) return;
  if(!requireVal($("unc_doc").value, "Falta Documento")) return;
  if(!requireVal($("unc_sede").value, "Falta Sede")) return;
  if(!requireVal($("unc_mpio").value, "Falta Municipio")) return;
  if(!requireVal($("unc_localidad").value, "Falta Localidad")) return;
  if(!requireVal($("unc_obs").value, "Falta Observaciones")) return;
  if(!requireGPS($("unc_lat"),$("unc_lon"),$("unc_acc"))) return;

  const fotos = await filesToDataURLs($("unc_fotos"));
  const tSave = nowISO();
  const gpsISO = $("unc_lat").dataset.gpsISO || "";

  const rec = {
    CD: activeCD,
    Nombres: upperText($("unc_nombres").value),
    Documento: upperText($("unc_doc").value),
    Sede: upperText($("unc_sede").value),
    Municipio: upperText($("unc_mpio").value),
    Localidad: upperText($("unc_localidad").value),
    RequiereMuro: $("unc_muro").checked ? "S√ç" : "NO",
    RequiereArriostre: $("unc_arriostre").checked ? "S√ç" : "NO",
    Latitud: $("unc_lat").value,
    Longitud: $("unc_lon").value,
    Precision: $("unc_acc").value,
    Observaciones: upperText($("unc_obs").value),
    Fotos: fotos,
    FECHA_HORA: new Date(tSave).toLocaleString(),
    GPS_HORA: gpsISO ? new Date(gpsISO).toLocaleString() : ""
  };

  await addRec("unc", rec);
  await metaSet("dirty", true);
  toast("Guardado ‚úÖ");

  // Limpieza autom√°tica
  ["unc_nombres","unc_doc","unc_localidad","unc_lat","unc_lon","unc_acc","unc_obs"].forEach(id=>$(id).value="");
  $("unc_lat").dataset.gpsISO="";
  $("unc_fotos").value="";
  $("unc_muro").checked=false;
  $("unc_arriostre").checked=false;
  $("gpsInfoUNC").textContent="";
}

async function guardarCLI(){
  await ensureReady();
  if(!activeCD){ toast("No hay CD activo"); return; }

  if(!requireVal($("cli_pf").value, "Falta Punto F√≠sico")) return;
  if(!requireVal($("cli_medidor").value, "Falta Serie medidor")) return;
  if(!requireVal($("cli_marca").value, "Falta Marca")) return;
  if(!requireVal($("cli_fases").value, "Falta Fases")) return;
  if(!requireVal($("cli_obs").value, "Falta Observaciones")) return;
  if(!requireGPS($("cli_lat"),$("cli_lon"),$("cli_acc"))) return;

  const fotos = await filesToDataURLs($("cli_fotos"));
  const tSave = nowISO();
  const gpsISO = $("cli_lat").dataset.gpsISO || "";

  const rec = {
    CD: activeCD,
    PuntoFisico: upperText($("cli_pf").value),
    SerieMedidor: upperText($("cli_medidor").value),
    Marca: upperText($("cli_marca").value),
    Fases: $("cli_fases").value,
    Latitud: $("cli_lat").value,
    Longitud: $("cli_lon").value,
    Precision: $("cli_acc").value,
    Observaciones: upperText($("cli_obs").value),
    Fotos: fotos,
    FECHA_HORA: new Date(tSave).toLocaleString(),
    GPS_HORA: gpsISO ? new Date(gpsISO).toLocaleString() : ""
  };

  await addRec("clientes", rec);
  await metaSet("dirty", true);
  toast("Guardado ‚úÖ");

  ["cli_pf","cli_medidor","cli_marca","cli_lat","cli_lon","cli_acc","cli_obs"].forEach(id=>$(id).value="");
  $("cli_lat").dataset.gpsISO="";
  $("cli_fotos").value="";
  $("cli_fases").value="";
  $("gpsInfoCLI").textContent="";
}

async function guardarSUS(){
  await ensureReady();
  if(!activeCD){ toast("No hay CD activo"); return; }

  if(!requireVal($("sus_pf").value, "Falta Punto F√≠sico")) return;
  if(!requireVal($("sus_motivo").value, "Falta Motivo")) return;
  if(!requireVal($("sus_obs").value, "Falta Observaciones")) return;
  if(!requireGPS($("sus_lat"),$("sus_lon"),$("sus_acc"))) return;

  const fotos = await filesToDataURLs($("sus_fotos"));
  const tSave = nowISO();
  const gpsISO = $("sus_lat").dataset.gpsISO || "";

  const rec = {
    CD: activeCD,
    PuntoFisico: upperText($("sus_pf").value),
    Motivo: upperText($("sus_motivo").value),
    Latitud: $("sus_lat").value,
    Longitud: $("sus_lon").value,
    Precision: $("sus_acc").value,
    Observaciones: upperText($("sus_obs").value),
    Fotos: fotos,
    FECHA_HORA: new Date(tSave).toLocaleString(),
    GPS_HORA: gpsISO ? new Date(gpsISO).toLocaleString() : ""
  };

  await addRec("susp", rec);
  await metaSet("dirty", true);
  toast("Guardado ‚úÖ");

  ["sus_pf","sus_lat","sus_lon","sus_acc","sus_obs"].forEach(id=>$(id).value="");
  $("sus_lat").dataset.gpsISO="";
  $("sus_fotos").value="";
  $("sus_motivo").value="";
  $("gpsInfoSUS").textContent="";
}

async function guardarBAL(){
  await ensureReady();
  if(!activeCD){ toast("No hay CD activo"); return; }

  if(!requireVal($("bal_pf").value, "Falta Punto F√≠sico")) return;
  if(!requireVal($("bal_estado").value, "Falta Estado")) return;
  if(!requireVal($("bal_obs").value, "Falta Observaciones")) return;
  if(!requireGPS($("bal_lat"),$("bal_lon"),$("bal_acc"))) return;

  const fotos = await filesToDataURLs($("bal_fotos"));
  const tSave = nowISO();
  const gpsISO = $("bal_lat").dataset.gpsISO || "";

  const rec = {
    CD: activeCD,
    PuntoFisico: upperText($("bal_pf").value),
    Estado: upperText($("bal_estado").value),
    Latitud: $("bal_lat").value,
    Longitud: $("bal_lon").value,
    Precision: $("bal_acc").value,
    Observaciones: upperText($("bal_obs").value),
    Fotos: fotos,
    FECHA_HORA: new Date(tSave).toLocaleString(),
    GPS_HORA: gpsISO ? new Date(gpsISO).toLocaleString() : ""
  };

  await addRec("baldios", rec);
  await metaSet("dirty", true);
  toast("Guardado ‚úÖ");

  ["bal_pf","bal_lat","bal_lon","bal_acc","bal_obs"].forEach(id=>$(id).value="");
  $("bal_lat").dataset.gpsISO="";
  $("bal_fotos").value="";
  $("bal_estado").value="";
  $("gpsInfoBAL").textContent="";
}

/* ==========================
   EXPORTAR (solo CD activo)
   - ZIP con carpetas por formulario y por registro
========================== */
async function exportAll(){
  await ensureReady();
  if(!activeCD){ toast("No hay CD activo"); return; }

  try{
    setBadge("Exportando‚Ä¶ üì¶");

    const [estr, unc, cli, sus, bal] = await Promise.all([
      getAll("estructuras"),
      getAll("unc"),
      getAll("clientes"),
      getAll("susp"),
      getAll("baldios")
    ]);

    const f = (arr)=>arr.filter(r=>r.CD === activeCD);

    const estrF = f(estr), uncF = f(unc), cliF = f(cli), susF = f(sus), balF = f(bal);

    const excelU8 = buildExcel(estrF, uncF, cliF, susF, balF);

    const d = new Date();
    const stamp = d.toISOString().slice(0,10).replace(/-/g,"");
    const hm = d.toTimeString().slice(0,5).replace(":","");
    const cdSafe = safeName(activeCD);
    const baseName = `GS_Diagnostico_${cdSafe}_${stamp}_${hm}`;

    const zip = new TinyZip();
    zip.add(`${baseName}.xls`, excelU8);

    const addFotos = (grupo, rec, folder)=>{
      const fol = safeName(folder);
      (rec.Fotos || []).forEach((f,i)=>{
        zip.add(`FOTOS/${grupo}/${fol}/foto_${i+1}.jpg`, dataURLtoU8(f.dataURL));
      });
    };

    estrF.forEach((r,i)=>addFotos("ESTRUCTURAS", r, `${r.PuntoFisico||"PF"}_${i+1}`));
    uncF.forEach((r,i)=>addFotos("UNC", r, `${r.Nombres||"UNC"}_${i+1}`));
    cliF.forEach((r,i)=>addFotos("CLIENTES", r, `${r.SerieMedidor||"MEDIDOR"}_${i+1}`));
    susF.forEach((r,i)=>addFotos("SUSPENSIONES", r, `${r.PuntoFisico||"PF"}_${i+1}`));
    balF.forEach((r,i)=>addFotos("BALDIOS", r, `${r.PuntoFisico||"PF"}_${i+1}`));

    const zipU8 = zip.finalize();
    const zipName = `${baseName}.zip`;

    // intento descarga inmediata
    try{ downloadU8(zipName, "application/zip", zipU8); }catch(e){}

    // respaldo: modal con link
    const blob = new Blob([zipU8], {type:"application/zip"});
    const url = URL.createObjectURL(blob);
    $("dlLink").href = url;
    $("dlLink").download = zipName;
    $("modalDL").style.display = "flex";

    await metaSet("dirty", false);
    setBadge("Listo ‚úÖ");
    toast("Exportado ‚úÖ");
  }catch(e){
    console.error(e);
    setBadge("Listo ‚úÖ");
    toast("Error exportando ‚ùå");
  }
}

/* ==========================
   CONTEOS
========================== */
async function conteos(){
  await ensureReady();
  const [estr, unc, cli, sus, bal] = await Promise.all([
    getAll("estructuras"),
    getAll("unc"),
    getAll("clientes"),
    getAll("susp"),
    getAll("baldios")
  ]);
  const f = (arr)=>activeCD ? arr.filter(r=>r.CD===activeCD).length : 0;
  $("conteosTxt").textContent = activeCD
    ? `CD ${activeCD}: ESTRUCTURAS=${f(estr)} | UNC=${f(unc)} | CLIENTES=${f(cli)} | SUSPENSIONES=${f(sus)} | BALDIOS=${f(bal)}`
    : "Sin CD activo.";
}

/* ==========================
   BOTONES / FLUJO
========================== */
function wireUI(){
  // navegaci√≥n
  $("btnVolverEstructuras").onclick = ()=>showOnly("formEstructuras");
  $("btnUNC").onclick = ()=>{ if(!activeCD) return toast("Primero guarda Estructuras"); showOnly("formUNC"); };
  $("btnCliente").onclick = ()=>{ if(!activeCD) return toast("Primero guarda Estructuras"); showOnly("formCliente"); };
  $("btnSusp").onclick = ()=>{ if(!activeCD) return toast("Primero guarda Estructuras"); showOnly("formSusp"); };
  $("btnBaldio").onclick = ()=>{ if(!activeCD) return toast("Primero guarda Estructuras"); showOnly("formBaldio"); };

  // dependencias de caracter√≠sticas
  $("tipoNodo").addEventListener("change", ()=>{ fillCarNodo(); });
  $("materialNodo").addEventListener("change", ()=>{ fillCarNodo(); });

  // GPS botones
  $("btnGPS_Est").onclick = ()=>captureGPS($("est_lat"),$("est_lon"),$("est_acc"),$("gpsInfoEst"));
  $("btnGPS_UNC").onclick = ()=>captureGPS($("unc_lat"),$("unc_lon"),$("unc_acc"),$("gpsInfoUNC"));
  $("btnGPS_CLI").onclick = ()=>captureGPS($("cli_lat"),$("cli_lon"),$("cli_acc"),$("gpsInfoCLI"));
  $("btnGPS_SUS").onclick = ()=>captureGPS($("sus_lat"),$("sus_lon"),$("sus_acc"),$("gpsInfoSUS"));
  $("btnGPS_BAL").onclick = ()=>captureGPS($("bal_lat"),$("bal_lon"),$("bal_acc"),$("gpsInfoBAL"));

  // dictado
  $("mic_est").onclick = ()=>startDictation($("est_obs"));
  $("mic_unc").onclick = ()=>startDictation($("unc_obs"));
  $("mic_cli").onclick = ()=>startDictation($("cli_obs"));
  $("mic_sus").onclick = ()=>startDictation($("sus_obs"));
  $("mic_bal").onclick = ()=>startDictation($("bal_obs"));

  // guardar
  $("btnGuardarEst").onclick = guardarEstructura;
  $("btnGuardarUNC").onclick = guardarUNC;
  $("btnGuardarCLI").onclick = guardarCLI;
  $("btnGuardarSUS").onclick = guardarSUS;
  $("btnGuardarBAL").onclick = guardarBAL;

  // cancelar
  $("btnCancelarUNC").onclick = ()=>showOnly("formEstructuras");
  $("btnCancelarCLI").onclick = ()=>showOnly("formEstructuras");
  $("btnCancelarSUS").onclick = ()=>showOnly("formEstructuras");
  $("btnCancelarBAL").onclick = ()=>showOnly("formEstructuras");

  // limpiar estructuras
  $("btnLimpiarEst").onclick = ()=>{
    $("tipoNodo").value=""; $("materialNodo").value=""; fillCarNodo();
    $("est_puntofisico").value="";
    $("est_lat").value=""; $("est_lon").value=""; $("est_acc").value="";
    $("est_lat").dataset.gpsISO="";
    $("est_obs").value="";
    $("est_fotos").value="";
    $("gpsInfoEst").textContent="";
    toast("Limpio ‚úÖ");
  };

  // export / conteos
  $("btnExportar").onclick = exportAll;
  $("btnConteos").onclick = conteos;

  // modal otro registro
  $("mUNC").onclick = ()=>{ $("modalOtro").style.display="none"; showOnly("formUNC"); };
  $("mCLI").onclick = ()=>{ $("modalOtro").style.display="none"; showOnly("formCliente"); };
  $("mSUS").onclick = ()=>{ $("modalOtro").style.display="none"; showOnly("formSusp"); };
  $("mBAL").onclick = ()=>{ $("modalOtro").style.display="none"; showOnly("formBaldio"); };
  $("mNO").onclick  = ()=>{ $("modalOtro").style.display="none"; showOnly("formEstructuras"); };

  // modal descarga
  $("dlClose").onclick = ()=>{ $("modalDL").style.display="none"; };

  // registrar diagn√≥stico: vuelve a estructuras y enfoca CD
  $("btnRegistrarDiag").onclick = ()=>{
    showOnly("formEstructuras");
    $("cdInput").focus();
  };

  // Modo continuar: pone el CD activo al input
  $("modoContinuar").addEventListener("change", async ()=>{
    await ensureReady();
    const cd = await metaGet("activeCD");
    if(cd){
      setActiveCD(cd);
      $("cdInput").value = cd;
      toast("CD activo cargado ‚úÖ");
    }else{
      toast("No hay CD activo");
      $("modoNuevo").checked = true;
    }
  });
  $("modoNuevo").addEventListener("change", ()=>{ /* nada */ });
}

async function boot(){
  // 1) engancha UI primero (para que no ‚Äúmuera‚Äù aunque falle algo)
  enforceUpperInputs();
  setSedeMunicipioUpper();
  wireUI();

  // 2) abre DB y carga estado
  try{
    await openDB();
    fillMunicipios();
    fillCarNodo();
    const cd = await metaGet("activeCD");
    if(cd){
      setActiveCD(cd);
      $("cdInput").value = cd;
      $("modoContinuar").checked = true;
    }else{
      setActiveCD("");
    }
  }catch(e){
    console.error(e);
    toast("Error inicializando DB");
  }

  // 3) service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("/sw.js").catch(()=>{});
  }
}

boot();
</script>
</body>
</html>
